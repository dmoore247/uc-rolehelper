{"version":"NotebookV1","origId":3484881153527950,"name":"Role Switch pyfunc setup","language":"python","commands":[{"version":"CommandV1","origId":3484881153527965,"guid":"bd10a21e-b049-44ab-9787-dcefef402cea","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n## Passing secrets in mlflow pyfunc models\n\ntags: roleswitcher\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"bcb1472a-f372-41ec-8e1d-a864778a96a7"},{"version":"CommandV1","origId":3484881153527966,"guid":"3f7466be-66ce-4474-baec-0417945e6548","subtype":"command","commandType":"auto","position":3.0,"command":"%pip install databricks-sdk==0.15.0 mlflow==2.9.2 mlflow-skinny[databricks]>=2.9.2\ndbutils.library.restartPython()","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"911cb521-c7f0-461c-8b42-65bfb7c3ab6c"},{"version":"CommandV1","origId":3484881153527967,"guid":"37a76c59-9203-49cb-b8c3-d04c46a975e9","subtype":"command","commandType":"auto","position":4.0,"command":"SCOPE = \"uc-rolehelper\"\nSECRET = \"tester\"\nCATALOG = \"douglas_moore\"\nSCHEMA  = \"roleswitcher\"\nMODEL_NAME = \"assume_role_pyfunc\"\nRUN_NAME = \"secret_test\"\nMODEL_DESCRIPTION = \"pyfunc endpoint housing uc-rolehelper switching logic\"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"870aba02-bdc0-4e11-8d42-39fa469319a7"},{"version":"CommandV1","origId":3484881153527968,"guid":"ccab218f-f644-4d39-a1af-6e18a55f820b","subtype":"command","commandType":"auto","position":5.0,"command":"from mlflow.pyfunc import PythonModel\nfrom mlflow.pyfunc.model import PythonModelContext\nfrom typing import Any, Dict, List, Optional\nimport numpy as np\nimport pandas as pd\nimport requests\nimport base64","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"c484501f-1435-42b2-a17f-942e62a56187"},{"version":"CommandV1","origId":3484881153527969,"guid":"89a9e3ea-4cbe-4524-834e-eae26bc53f04","subtype":"command","commandType":"auto","position":6.0,"command":"# Model wrapper class\nimport databricks\nfrom databricks.sdk import WorkspaceClient\n\nclass SecretTest(PythonModel):\n\n    def __init__(self, secret):\n        self.init_secret = secret\n\n    def load_context(self, context):\n        ws = WorkspaceClient()\n        self.ws_secret = base64.b64decode(ws.secrets.get_secret(SCOPE, SECRET).value).decode(\"utf-8\")\n\n    def predict(self, context: PythonModelContext,\n                      model_input,\n                      params: Optional[Dict[str, Any]] = {'temperature': 0.01}):\n\n        return [(self.init_secret).upper() + \" \" + self.ws_secret.upper()]","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ed8b68d1-1062-4205-aa8d-78a8364c7d50"},{"version":"CommandV1","origId":3484881153527970,"guid":"bfd7d83b-8523-48ae-a1c1-d2c4c275f357","subtype":"command","commandType":"auto","position":7.0,"command":"from mlflow.pyfunc.model import PythonModelContext\nfrom mlflow.models.signature import ModelSignature \nfrom mlflow.types.schema import Schema, ColSpec\nmodel_config = {}\ninput_schema = Schema(\n       [\n           ColSpec(name=\"user\", type=\"string\"),\n           ColSpec(name=\"role\", type=\"string\"),\n\n       ]\n)\noutput_schema = Schema([ColSpec(name=\"status\", type=\"string\")])\nsignature = ModelSignature(inputs=input_schema, outputs=output_schema)\npythonModelContext = PythonModelContext(model_config={}, artifacts={})","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"9fd43a53-6784-4a7e-b336-e030ee860c66"},{"version":"CommandV1","origId":3484881153527971,"guid":"233b333a-b8b3-4d21-b227-c234a20044c5","subtype":"command","commandType":"auto","position":8.0,"command":"#local test:\nfrom mlflow.pyfunc.model import PythonModelContext\nsecretTest = SecretTest(secret=dbutils.secrets.get(SCOPE, SECRET))\npythonModelContext = PythonModelContext(model_config=model_config, artifacts={})\nsecretTest.load_context(pythonModelContext)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"20715f2f-35d7-4a46-bc36-3ed033b06029"},{"version":"CommandV1","origId":3484881153527972,"guid":"c644e321-5ad6-4ac8-a930-70c24530e2c7","subtype":"command","commandType":"auto","position":9.0,"command":"secretTest.predict(context = pythonModelContext, model_input = \"\")","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"d9a6e1af-22d5-4ffd-b6d2-b3f4bbb1d464"},{"version":"CommandV1","origId":3484881153527973,"guid":"fa008096-a507-46f1-a555-abf75a249954","subtype":"command","commandType":"auto","position":10.0,"command":"# Saving to endpoint:\nimport mlflow\nfrom mlflow.models import infer_signature\nwith mlflow.start_run(run_name=RUN_NAME, description=MODEL_DESCRIPTION) as run:\n    #signature = infer_signature(model_input, model_output)\n    pip_requirements = [\"mlflow[gateway]==2.9.2\", \"pandas\", \"numpy\"]\n    mlflow.pyfunc.log_model(RUN_NAME, \n                            python_model=secretTest,\n                            signature=signature,\n                            pip_requirements=[\"databricks-sdk==0.15.0\", \"base64\"]\n                            )\n    run_id = run.info.run_id\n\nprint(run.info.run_id)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"40582c4e-5dd3-4578-bc4e-002cf46d9c01"},{"version":"CommandV1","origId":3484881153527974,"guid":"50542e98-5bd4-4863-ba38-c8a09825bed4","subtype":"command","commandType":"auto","position":11.0,"command":"%md ## Register the model\nRegister the model to Unity Catalog","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ef426e1c-78ad-4014-ac9d-f904dc1d1ad9"},{"version":"CommandV1","origId":3484881153527975,"guid":"eb5cb5c9-0a9b-41e6-b259-b292b992385f","subtype":"command","commandType":"auto","position":12.0,"command":"%sql \nCREATE SCHEMA IF NOT EXISTS douglas_moore.roleswitcher","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"aa8d53a4-a6a2-4bc6-8cb0-155c82166113"},{"version":"CommandV1","origId":3484881153527976,"guid":"fb9216d1-f331-4d24-8894-200b6e29844a","subtype":"command","commandType":"auto","position":13.0,"command":"# Register model to unity catalog\n\nmlflow.set_registry_uri(\"databricks-uc\")\ntags = {\"project\":\"uc-roleswitcher\"}\nmlflow.register_model(\n    f\"runs:/{run.info.run_id}/secret_test\", \n    f\"{CATALOG}.{SCHEMA}.{MODEL_NAME}\",\n    tags=tags)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"c5bcd837-40e5-481b-a0e5-335efee98ed1"},{"version":"CommandV1","origId":3484881153527977,"guid":"7ed092d6-44e5-499f-a7d0-b3d3c54d9308","subtype":"command","commandType":"auto","position":14.0,"command":"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"385260e7-86cb-4ca2-88dd-de0a68345181"}],"dashboards":[],"guid":"96191234-3d49-4b29-86de-60b7eb691937","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE","environmentMetadata":null}