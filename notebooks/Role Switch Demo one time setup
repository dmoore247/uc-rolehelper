{"version":"NotebookV1","origId":4316142535518375,"name":"Role Switch Demo one time setup","language":"python","commands":[{"version":"CommandV1","origId":1501600681754815,"guid":"c0e6e662-d8a2-4b80-9ac7-ded29a038e47","subtype":"command","commandType":"auto","position":2.0,"command":"%md # One time UC Role Switch Demo Setup","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"655c23fa-46e1-463c-a121-4114b4ca787c"},{"version":"CommandV1","origId":1501600681754816,"guid":"a910fc98-bfa9-455d-9c6b-e7a4b4c40942","subtype":"command","commandType":"auto","position":3.0,"command":"%md ## Setup notes\nGroups\n- Create group `roleswitchers`, this group has all users and groups associated with role switching\n- In Account Admin -> Workspaces -> Permissions, add `roleswitchers` to workspace\n- User must belong to a group that has permissions on the working workspace\n\n'Roles'\n- Roles are Unity Catalog Groups\n- Create a UC group for each Role\n- Each Role is assigned permissions to securables (Catalogs, Schemas, Shares, Volumes, Tables, Views, Models,...)\n- The system is designed such that each 'Role' is complete, membership in a role is 'exclusive'. You may belong to only one Role at a time.\n\nSecurables\n- All securables are owned by a service principal in this demo, 'roleswitcher_sp' though doesn't have to be\n\nPackages\n- Make sure to explicitly install `databricks-sdk` 0.7.0 or higher. The default databricks-sdk package is 0.1.6 which is too low to work properly and will quickly return an error.\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"823b4e12-5ace-4cbc-9299-5e45529e2c83"},{"version":"CommandV1","origId":1501600681754817,"guid":"3e88b36c-b060-4637-9c31-476683217cbb","subtype":"command","commandType":"auto","position":4.0,"command":"%md ## Install dependencies","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"727f7e08-ed84-45a9-a7d1-e05b83e6c2dd"},{"version":"CommandV1","origId":1501600681754818,"guid":"f9aea937-88af-4bd2-ad2a-37a6e4869e8b","subtype":"command","commandType":"auto","position":5.0,"command":"%pip install --quiet databricks-sdk==0.7.0","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a8d5e413-0344-4c0e-ba2f-f7e248a3edeb"},{"version":"CommandV1","origId":1501600681754819,"guid":"237af3df-4211-4061-806f-e98e66cbfe47","subtype":"command","commandType":"auto","position":6.0,"command":"# dbutils.library.restartPython()","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"0015a9d2-d5d7-4e4c-a6fd-7d7c0be79cc4"},{"version":"CommandV1","origId":1501600681754820,"guid":"ce7dc1b0-5b1b-41ae-8573-3c01f0911d09","subtype":"command","commandType":"auto","position":7.0,"command":"import logging\nlogging.basicConfig(level=logging.INFO)\n\nfrom dbx.ucrolehelper import UCRoleHelper\nfrom dbx.ucrolehelper import version as ucrolehelper_version\nfrom dbx.ucrolehelper import config\nfrom databricks.sdk import version as databricks_sdk_version\nfrom databricks.sdk.core import DatabricksError\n\nlogging.info(f'dbx.ucrolehelper version: {ucrolehelper_version.__version__}')\nlogging.info(f'databricks_sdk          version: {databricks_sdk_version.__version__}')\n\nassert databricks_sdk_version.__version__ >= \"0.7.0\"\n\nfrom dbx.ucrolehelper.config import role_switcher_admin","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5c94f8f7-17c0-4fda-a6b9-0682e1b80b4c"},{"version":"CommandV1","origId":1501600681754821,"guid":"8e937eb1-ebdc-4610-a354-c9010f256c89","subtype":"command","commandType":"auto","position":8.0,"command":"\nfrom databricks.sdk import AccountClient, WorkspaceClient\nfrom databricks.sdk.service import iam\n\nimport pprint\npp = pprint.PrettyPrinter(indent=4)\n\n\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"9ab1791b-1a4d-41f4-8598-b8e2aace480b"},{"version":"CommandV1","origId":1501600681754822,"guid":"a99aa887-7a46-4bc9-abc4-6b75c06c8253","subtype":"command","commandType":"auto","position":9.0,"command":"%md ## Enable apps\n\n```\ncurl --netrc --request POST \\\n https://accounts.cloud.databricks.com/api/2.0/accounts/${DATABRICKS_ACCOUNT_ID}/oauth2/published-app-integrations \\\n--header 'Content-Type: application/json' \\\n--data '{ \"app_id\": \"databricks-cli\" }'\n```","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"07666dd1-e57a-4791-98fe-184270c2dea4"},{"version":"CommandV1","origId":1501600681754823,"guid":"bc581684-d341-4d25-8566-84bc37c2f404","subtype":"command","commandType":"auto","position":10.0,"command":"%md ## Connect","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"4f373f75-5ca1-43b7-9587-79e6e43296cd"},{"version":"CommandV1","origId":1501600681754824,"guid":"27fc83ff-f748-4200-8c41-edf157558fa8","subtype":"command","commandType":"auto","position":11.0,"command":"logging.info(f\"Connecting {config['account_host']}:{config['account_id']}\")\nu = UCRoleHelper(config=config, roles=roles, assume_username='douglas.moore+UC@databricks.com')","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"3ab4c82d-7e7e-4c72-b076-97e019c32901"},{"version":"CommandV1","origId":1501600681754825,"guid":"134cd2ce-a890-49fb-9deb-954a4bad04d4","subtype":"command","commandType":"auto","position":12.0,"command":"%md ## Install Service Principal","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"482329fd-526d-4a93-b381-d4559414dbe1"},{"version":"CommandV1","origId":1501600681754826,"guid":"84440df5-6adc-4487-8af4-420681a87545","subtype":"command","commandType":"auto","position":13.0,"command":"service_principal_name = config['sp_display_name']\n\ndef create_principal(service_principal_name: str):\n    logging.info(f'Creating service principal {service_principal_name}')\n    # clean up previous one\n    principals = u.a.service_principals.list(filter=f'displayName eq {service_principal_name}')\n    for principal in principals:\n        u.a.service_principals.delete(id = principal.id)\n\n    try:\n        principal = u.a.service_principals.create(\n            display_name = service_principal_name\n            )\n    except DatabricksError as e:\n        logging.warning(f'Databricks Errror on create service principal {service_principal_name} : {e}')\n\n\nprincipals = u.a.service_principals.list(filter=f'displayName eq {service_principal_name}')\nlogging.info(principals)\n\ngroups = u.a.groups.list(filter=f'displayName co {roles[0][10:]}')\nlogging.info(groups)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ab02bc29-75c7-4c2c-89da-25c5ff3ca21f"},{"version":"CommandV1","origId":1501600681754827,"guid":"2d5b049e-19b3-4ac1-b476-caed41c02608","subtype":"command","commandType":"auto","position":14.0,"command":"%md ## Setup demo catalog","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"14663011-2fcf-4fc9-8b02-a77896b5a5be"},{"version":"CommandV1","origId":1501600681754828,"guid":"3875ad85-c1c5-401d-9769-93c8c4857b74","subtype":"command","commandType":"auto","position":15.0,"command":"from dbx.ucrolehelper.config import catalog_name\nfrom databricks.sdk.service import catalog\n\ntry:\n    logging.info(f'Deleting catalog {catalog_name}')\n    u.w.catalogs.delete(name=catalog_name, force=True)\nexcept DatabricksError as e:\n    logging.warning(f'Databricks Errror on delete catalog {catalog} : {e}')\n\ntry:\n    logging.info(f'Creating catalog {catalog_name}')\n    u.w.catalogs.create(name=catalog_name, comment=\"Role switch demo\")\nexcept DatabricksError as e:\n    logging.warning(f'Databricks Errror on create catalog {catalog} : {e}')\n    \ntry:\n    logging.info(f'Changing owner catalog {catalog_name} to {role_switcher_admin}')\n    u.w.catalogs.update(name=catalog_name, owner=role_switcher_admin)\nexcept DatabricksError as e:\n    logging.warning(f'Databricks Errror on update catalog {catalog} owner {role_switcher_admin}: {e}')\n\ntry:\n    u.w.grants.update(\n        securable_type=catalog.SecurableType.CATALOG, \n        full_name=catalog_name,\n        changes=[\n                catalog.PermissionsChange(add=[catalog.Privilege.USE_CATALOG],\n                                            principal=role_switcher_admin)\n                    ])\nexcept DatabricksError as e:\n    logging.warning(f'Databricks Errror on grant on catalog {catalog} : {e}')\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"4e67bdb2-2a2f-4d9d-91fd-49e98795edeb"},{"version":"CommandV1","origId":1501600681754829,"guid":"bec9dafd-9ed4-47d4-8c39-f1f311ac1587","subtype":"command","commandType":"auto","position":16.0,"command":"%md ## Setup Demo Roles, Groups, Schemas, tables etc...","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7fa878dc-b779-42c5-b694-6b4dc519f012"},{"version":"CommandV1","origId":1501600681754830,"guid":"9e3a282c-41f8-49ba-88db-bf4aae454f98","subtype":"command","commandType":"auto","position":17.0,"command":"for role in roles:\n    \n    try:\n        logging.info(f'Create group {role}')\n        u.a.groups.create(display_name=role)\n    except DatabricksError as e:\n       logging.warning(f'Databricks Errror on group create {role} : {e}')\n    try:\n        logging.info(f'Create schema {catalog_name}.{role}')\n        u.w.schemas.create(name=role, catalog_name=catalog_name, comment=\"Role switch demo\")\n    except DatabricksError as e:\n       logging.warning(f'Databricks Errror on schema create {role} : {e}')\n\n    # update owner\n    schema_name = f'{catalog_name}.{role}'\n    try:\n        logging.info(f'Update owner {schema_name} TO {role_switcher_admin}')\n        u.w.schemas.update(full_name=schema_name, owner=role_switcher_admin)\n    except DatabricksError as e:\n        logging.warning(f'Databricks Errror on update schema {schema_name} owner {role_switcher_admin}: {e}')\n\n    # update grants\n    try:\n        logging.info(f'Update grants {schema_name} TO {role_switcher_admin}')\n        u.w.grants.update(\n        securable_type=catalog.SecurableType.SCHEMA, \n        full_name=schema_name,\n        changes=[\n                catalog.PermissionsChange(\n                    add=[catalog.Privilege.ALL_PRIVILEGES],\n                    principal=role_switcher_admin)\n                ])\n    except DatabricksError as e:\n        logging.warning(f'Databricks Errror on schema grant {role} : {e}')\n        \n    # create sample table\n    table_name = 'the_table'\n    try:\n        logging.info(f'CTAS {catalog_name}.{role}.{table_name}')\n        _ = u.w.statement_execution.execute_statement(\n            warehouse_id=config['warehouse_id'],\n            catalog=catalog_name,\n            schema=role,\n            statement=f\"CREATE OR REPLACE TABLE {table_name} AS SELECT '{role}' AS role_name, id FROM range(10)\"\n            )\n        if _.status == 'FAILED':\n            logging.warning(f'CREATE TABLE {table_name} failed: {_.error}')\n        \n        logging.info(f'SELECT {catalog_name}.{role}.{table_name}')\n        _ = u.w.statement_execution.execute_statement(\n            warehouse_id=config['warehouse_id'],\n            catalog=catalog_name,\n            schema=role,\n            statement=f\"SELECT * from TABLE {table_name}\"\n            )\n        if _.status == 'FAILED':\n            logging.warning(f'SELECT TABLE {table_name} failed: {_.error}')\n    except DatabricksError as e:\n        logging.warning(f'Databricks Errror on create table {catalog_name}.{schema_name}.{table_name} : {e}')\n    \n    # update owner\n    full_name = f'{catalog_name}.{role}.the_table'\n    try:\n        logging.info(f'ALTER TABLE {full_name} SET OWNER TO {role_switcher_admin}')\n        u.w.tables.update(full_name=full_name, owner=role_switcher_admin)\n    except DatabricksError as e:\n        logging.warning(f'Databricks Errror on update table {full_name} owner {role_switcher_admin}: {e}')","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"48d278f1-9a9d-474b-9504-3935505cf1cb"}],"dashboards":[],"guid":"2508319d-a9f3-4c8c-8d0d-1dd41101fcc6","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{},"reposExportFormat":"SOURCE","environmentMetadata":null}