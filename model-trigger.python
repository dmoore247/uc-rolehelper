{"version":"NotebookV1","origId":366192547804410,"name":"model-trigger","language":"python","commands":[{"version":"CommandV1","origId":4349847305562453,"guid":"60f107d7-65ad-4672-ae86-58215daf6bdd","subtype":"command","commandType":"auto","position":2.0,"command":"%pip install --upgrade \"mlflow-skinny[databricks]>=2.5.0\" tensorflow\ndbutils.library.restartPython()","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"39efa753-9fda-4de8-bf6a-7428252b8d84"},{"version":"CommandV1","origId":4349847305562454,"guid":"51fcb617-9117-4e70-81ec-511a07abf12b","subtype":"command","commandType":"auto","position":3.0,"command":"import mlflow\nfrom mlflow.models import infer_signature\nmlflow.set_registry_uri(\"databricks-uc\")\nMODEL_NAME = \"douglas_moore.demo.trigger-model\"\ninput_example=\"new-role\"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ca9bea53-f6ec-48ca-9220-7c8abcbdf971"},{"version":"CommandV1","origId":4349847305562455,"guid":"adb978c1-229e-4310-ac9b-820a52eedb41","subtype":"command","commandType":"auto","position":4.0,"command":"# define a custom model\nclass MyModel(mlflow.pyfunc.PythonModel):\n    def predict(self, context, model_input, params=None):\n        return self.my_custom_function(model_input, params)\n\n    def my_custom_function(self, model_input, params=None):\n        # do something with the model input\n        return {\"result\": \"hello \" + str(model_input) + \" \" + str(params)}\n\n\nsome_input = {\"new_role\":\"role1\"}\n# save the model\nwith mlflow.start_run():\n    model_info = mlflow.pyfunc.log_model(\n        artifact_path=\"model\", \n        python_model=MyModel(),\n        metadata={\"model_metadata_key\": \"metadata_value\"},\n        signature=infer_signature(model_input={\"new_role\":\"role0\"},model_output={\"result\":\"value\"}),\n        registered_model_name=MODEL_NAME\n)\n\n# load the model\nloaded_model = mlflow.pyfunc.load_model(model_uri=model_info.model_uri)\nprint(type(loaded_model))  # <class 'mlflow.pyfunc.model.PyFuncModel'>\n\nunwrapped_model = loaded_model.unwrap_python_model()\nprint(type(unwrapped_model))  # <class '__main__.MyModel'>\n\n# does not work, only predict() is exposed\n# print(loaded_model.my_custom_function(some_input))\n\nprint(unwrapped_model.my_custom_function(some_input))  # works\n\nprint(loaded_model.predict(some_input))  # works\n\n# works, but None is needed for context arg\nprint(unwrapped_model.predict(None, some_input))\n","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"050ad1ce-4f8f-4772-9d72-e9a4702db3d1"},{"version":"CommandV1","origId":4349847305562456,"guid":"15c6e487-9376-4187-a81b-12d02001e206","subtype":"command","commandType":"auto","position":5.0,"command":"%md Load model from registry and call it","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"d96c0368-e1d7-4f8b-bfeb-e5e59906a57f"},{"version":"CommandV1","origId":4349847305562457,"guid":"d2ab531f-9be7-4e87-84ef-813480ce027d","subtype":"command","commandType":"auto","position":6.0,"command":"import mlflow.pyfunc\n\nmodel_version_uri = \"models:/{model_name}/1\".format(model_name=MODEL_NAME)\n\nprint(\"Loading registered model version from URI: '{model_uri}'\".format(model_uri=model_version_uri))\nmodel_version_1 = mlflow.pyfunc.load_model(model_version_uri)\n\nmodel_champion_uri = \"models:/{model_name}@Champion\".format(model_name=MODEL_NAME)\n\nprint(\"Loading registered model version from URI: '{model_uri}'\".format(model_uri=model_champion_uri))\nchampion_model = mlflow.pyfunc.load_model(model_champion_uri)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a8dfc763-a22e-4ec6-a2a9-7444f69562e3"},{"version":"CommandV1","origId":4349847305562458,"guid":"956ff23d-3273-4535-9879-bc400e81c254","subtype":"command","commandType":"auto","position":7.0,"command":"champion_model.predict({\"new_role\":\"role2\"})","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b3c8583a-734f-4e5f-a22e-399a44a28365"},{"version":"CommandV1","origId":4349847305562459,"guid":"776c306f-cda8-4af1-a1ae-44737b058998","subtype":"command","commandType":"auto","position":8.0,"command":"%md now try the model","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"911dc3e6-4ed7-4498-8f5d-6628039c52ea"},{"version":"CommandV1","origId":4349847305562460,"guid":"ba5a5708-ba6d-459e-9291-20dc6e9be703","subtype":"command","commandType":"auto","position":9.0,"command":"import mlflow\nlogged_model = 'runs:/94d7eb43923542559d3ddf410845e99c/model'\n\n# Load model as a PyFuncModel.\nloaded_model = mlflow.pyfunc.load_model(logged_model)\n\ndata = \"blax\"\n\n# Predict on a Pandas DataFrame.\nimport pandas as pd\nloaded_model.predict(data)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"17505638-2174-42bd-a7a2-64164c618fdc"},{"version":"CommandV1","origId":4349847305562461,"guid":"b9003e75-02ef-4c3f-8e1e-1ba8693236bf","subtype":"command","commandType":"auto","position":10.0,"command":"","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"0b6dcbdf-c07b-4e64-b504-59cbf7e1c742"}],"dashboards":[],"guid":"e211f5c5-01de-4e62-8205-2bda1911cb5f","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{},"reposExportFormat":"SOURCE","environmentMetadata":null}